<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="Jenkins Gadget" /> 
  <UserPref name="jenkins_url" display_name="Jenkins REST URL" default_value="http://&lt;server&gt;/jenkins/view/&lt;viewname&gt;/api/json?depth=1&amp;jsonp=?"/>
  <UserPref name="nr_of_columns" display_name="Nr. of columns" default_value="1"/>
  <Content type="html" view="home,default,canvas,wallboard">
     <![CDATA[
	<html>
	<head>
		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script src="http://code.jquery.com/ui/1.8.17/jquery-ui.min.js"></script>
		<style> 
			.panelcontainer {
				width: 	100%;
				height: 100%;
			}

			.panelrow {
				clear: 	both;
			}

			.panelcell {
				height: 100%;
				float:	left;
				margin: 1px;
				border-radius:20px;
				text-align: center;
				color: #ffffff; 
				font-family: Helvetica; 
				text-align: center;			
			}	
		</style>
	</head>
	<body style="background-color: #000">
		<div id="jobs"/>
		<script>
			var prefs = new gadgets.Prefs();
			
			getDataFromJenkins();
			setInterval(getDataFromJenkins, 10000);

		  	function getColor(color) {
				if (color == 'blue' || color == 'blue_anime') {
					return '#336600'
				}

				if (color == 'yellow' || color == 'yellow_anime') {
					return '#FF9900'
				}
				
				if (color == 'disabled' || color == 'disabled_anime' 
							|| color == 'aborted' || color == 'aborted_anime') {
					return '#B3B3B3'
				}

				return '#990000'
		  	}

			function isInProgress(color) {
				return color.indexOf('anime') > -1;
			}

		 	function getDataFromJenkins() { 
				$("#jobs").empty();
		
				$.getJSON(prefs.getString('jenkins_url'),
			 	 	function(data) {
						var nrOfJobs 		= data.jobs.length;
						var nrOfColumns 	= prefs.getInt('nr_of_columns');
						var jobHeight 		= 90 / (nrOfJobs / nrOfColumns);
						var jobWidth 		= 99 / nrOfColumns;
						var columnCounter 	= 1;
						var jobs 			= [];
						$.each(data.jobs, function(key, job) {
							var className = isInProgress(job.color) ? 'pulsate' : '';

							if (columnCounter == 1) {
								jobs.push('<div class="panelrow" style="height:' + jobHeight + '%;">');
							}
							
							var jobFontSize = ($(document).height() / 120) * jobHeight;

							jobs.push('<div class="panelcell ' 
										+ className +'" id="' + key 
										+ '" style="background-color: ' 
										+ getColor(job.color)  
										+ ';border-radius: 10px;width:' 
										+ jobWidth + '%;' 
										+ 'font-size: ' + jobFontSize + 'px;">' 
										+ job.name + '</div>');

							if (columnCounter == nrOfColumns) {
								jobs.push('</div>')
								columnCounter = 1;
							} else {
								columnCounter++					
							}
						});

						$('#jobs').prepend(jobs.join(''));
						$(".pulsate").effect("pulsate", { times:5 }, 2000);
			  	});
			}
		</script>
	</body>
	</html>
	]]>
  </Content> 
</Module>